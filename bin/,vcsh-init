#!/usr/bin/env bash
# Bootstrap the vcsh init process
#   $1 Repository name

set -e

# has argument
if [[ $# -eq 0 ]]; then
    >&2 echo "usage: $(basename "$0") REPOSITORY"
    exit 1
fi

# GitHub user
USERNAME="$(git config github.user || true)"
if [[ -z $USERNAME ]]; then
    cat <<EOF >&2
E: Configure your GitHub user with:

    git config --global github.user USERNAME
EOF
    exit 1
fi

# variables
REPO="$1"
PREFIX="$HOME/.config"

AVAIL_DIR="$PREFIX/mr/available.d"
CONFIG_DIR="$PREFIX/mr/config.d"
IGNORE_DIR="$HOME/.gitignore.d"
REPO_DIR="$PREFIX/vcsh/repo.d/$REPO.git"

AVAIL_FILE="$AVAIL_DIR/$REPO.vcsh"
CONFIG_FILE="$CONFIG_DIR/$REPO.vcsh"
IGNORE_FILE="$IGNORE_DIR/$REPO"

# vcsh(1) init
if [[ -d $REPO_DIR ]]; then
    >&2 echo "E: Repository '$REPO' already exists"
    exit 1
fi
vcsh init "$REPO"

# create directories
mkdir -p "$AVAIL_DIR" "$CONFIG_DIR" "$IGNORE_DIR"

# generate dummy .gitignore
touch "$IGNORE_FILE"

# mr(1) files
cat <<EOF > "$AVAIL_FILE"
[\$HOME${REPO_DIR#$HOME}]
checkout = vcsh clone https://github.com/$USERNAME/vcsh-$REPO.git $REPO
EOF
ln -s "../available.d/$REPO.vcsh" "$CONFIG_FILE"
vcsh "$REPO" add "$AVAIL_FILE" "$CONFIG_FILE" "$IGNORE_FILE"

# note about .gitignore.d
B= ; R=
if [[ -t 1 ]]; then
    B=$'\e[1m' # bold
    R=$'\e[0m' # roman
fi
cat <<EOF
Remember to run after adding all files

    ${B},vcsh-write-gitignore $REPO && vcsh $REPO add .${R}

to fill the gitignore
EOF
